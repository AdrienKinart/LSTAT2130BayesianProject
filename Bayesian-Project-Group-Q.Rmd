---
# You need to knit from "Project Directory"
# Document information

title: "LSTAT2130 - Bayesian Statistics"
subtitle: "Project - Group Q"

authors:
  - "Lionel Lamy - 1294-1700"
  - "Adrien Kinart"
  - "Simon Lengendre"

# If multiple authors: - "Lionel Lamy - 1294-1700" is prettier.

# ---

# Logo cant have special char in the path as underscore
logo: "resources/img/UCLouvainLogoSciences.jpg"

institute: "Université catholique de Louvain"
faculty: "Louvain School of Statistics"
# department: ""

context: ""
date: \today

# ---
colorlinks: false
bordercolorlinks: true

linkcolor: "black"
urlcolor:  "black"
citecolor: "blue"

linkbordercolor: "black"
urlbordercolor: "black"
citebordercolor: "blue"

links-as-notes: false
# ---
# header-includes: 
#   -
output:
  pdf_document:
    template: template/markdown.tex
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  cache = TRUE,
  echo = F,
  eval = T,	
  	
  warning = F,	
  message = F,
  
  	
  out.width= "80%",
  fig.align = "center",	
  fig.path = "resources/figs/",
  
  tidy=TRUE,
  tidy.opts=list(width.cutoff=70)
)	
```

# Introduction

```{r}
library(EnvStats)
```

```{r matrix_setup}
Table <- matrix(data= c(25,69, 65,106, 80,106,136,94,76,46,
                       17,36, 47,58 , 47,53 ,59 ,54,33,21),
                nrow = 2, byrow = T)
rownames(Table) <- c("Flanders", "Wallonia") 
colnames(Table) <- c("<1200", "[1200-1500)", "1500-1800", "1800-2300", "2300-2700",
                     "2700-3300", "3300-4000", "4000-4900", "4900-6000", ">6000")

NbFlemish <-  sum(Table[1,])
NbWaWalloons <-sum(Table[2,])  
```




```{r functions_setup}
kappaFct <- function(phi){1/phi}
lambdaFct <- function(phi,mu){1/(phi*mu)}
```

```{r flanders_wallonia}
# Flanders
Fl <- c(rep(1200,25), rep(1350,69), rep((1500+1800)/12,65), rep((1800+2300)/2,106),rep((2300+2700)/2,80), rep(3000,106),
        rep((3300+4000)/2,136), rep(4450,94),rep((4900+6000)/2,76), rep(6000,46))

Estimation_Fl <-  egamma(Fl)
Estimated_kappa_Fl <- Estimation_Fl$parameters["shape"]
Estimated_lambda_Fl <- 1/Estimation_Fl$parameters["scale"]
Estimated_mu_Fl <- Estimated_kappa_Fl/Estimated_lambda_Fl
Estimated_mu_Fl
estimGamma_Fl <- rgamma(10000,Estimated_kappa_Fl,Estimated_lambda_Fl)
hist(Fl, probability = T, xlim = c(-500,8000))
curve(dgamma(x,Estimated_kappa_Fl,Estimated_lambda_Fl), add = TRUE)

# Wallonia
Wall <- c(rep(1200,17), rep(1350,36), rep((1500+1800)/12,47), rep((1800+2300)/2,58),rep((2300+2700)/2,47), rep(3000,53),
        rep((3300+4000)/2,59), rep(4450,54),rep((4900+6000)/2,33), rep(6000,21))


Estimation_Wall <-  egamma(Wall)
Estimated_kappa_Wal <- Estimation_Wall$parameters["shape"]
Estimated_lambda_Wal <- 1/Estimation_Wall$parameters["scale"]
Estimated_mu_Wal <- Estimated_kappa_Wal/Estimated_lambda_Wal
Estimated_mu_Wal
estimGamma_Wal <- rgamma(10000,Estimated_kappa_Wal,Estimated_lambda_Wal)
hist(Wall, probability = T, xlim = c(-500,8000))
curve(dgamma(x,Estimated_kappa_Wal,Estimated_lambda_Wal), add = TRUE)

```



```{r JustAnExample}
muExample <- 2500; phiExample <- 1
kappaExample <- kappaFct(phiExample)
lambdaExample <- lambdaFct(muExample,phiExample)

pgamma(2700,kappaExample,lambdaExample)-pgamma(2300,kappaExample,lambdaExample)
dgamma(2700, kappaExample, lambdaExample)
```

# Question 1
Let $\theta_k:= (\mu_k, \phi_k)$ be the set of parameters for a HNI with respect to region $k$.

## (a) Theoretical probability

Let $X$ be the monthly net income of 1123 Belgian households net income (HNI) older than 30 years. Regardless the 2 regions ($k=\{1,2\}$ wrt Flanders and Wallonnia, respectively), is assumed it follows a Gamma distribution. It can be reparametrised in terms of its mean $\mu$ and dispersion parameter $\phi$ with the following trick: 


$$
\begin{split}
\text{shape: } \kappa & = \frac{1}{\phi} \\
\text{rate: } \lambda & = \frac{1}{\phi\; \mu}
\end{split}
$$


For both regions $k=\{1,2\}$: This gives


$$
f(x_k) = \frac{(\phi_k\mu_k)^{-1/\phi_k}}{\Gamma(\phi_k^{-1})} \
x_k^{1/\phi_k-1} \exp{(\frac{-x_k}{\phi_k \mu_k})}
$$

Then, the probability to fall into a certain HNI interval is: 

$$
P(x_{k,j} < x_k < x_{k,j+1}) =\int_{x_{j}}^{x_{j+1}} \frac{(\phi_k \mu_k)^{-1/\phi_k}}{\Gamma(\phi_k^{-1})} x_k^{1/\phi_k-1} \exp{(\frac{-x_k}{\phi_k \mu_k})}\ \diff{x}
$$



## (b) Theoretical expression for the likelihood
On behalf of writing simplicity, the region index is removed. Since the frequency distribution in a given region is multinomial, i.e. 

We have, writing $P:=(p{1},..,p_{10})$ and $X:= (X_{1},... X_{10})$:

$$
\begin{split}
X | P  \sim \text{Mul}(N,P)  & = \frac{x!}{x_{1}! \, ... \, x_{10}! } p_1^{x_1} \times ... \times p_{10}^{x_{10}} \; \text{when} \sum_{j=1}^{10} p_j = 1 \\
&=0 \; \text{otherwise}
\end{split}
$$

Up to a multiplicative constant, the likelihood can be written as follow:

$$
\begin{split}
L(\theta, D) = P (D | \mu, \phi) \propto \prod_{j=1}^{10} p_j
\end{split}
$$
$p_j$ corresponds to the area in the $j^{\text{th}}$ interval. One can take the approximation mean the mean,e.g. $x_{Flanders,3} = (1500+1800)/2 = 1650$ ? On can approximate that with $f(x_i) \Delta$ where $\Delta$ is the unit of measurement. 

$$
\begin{split}
p_j =P(x_j - \frac{\Delta_j}{2} < x_j <x_j + \frac{\Delta_j}{2} ) & \approx f(x_j) \Delta_j \\
& \approx \frac{1}{\Gamma(\phi_k^{-1})} \big( \phi_k \mu \big)^{-1/\phi_k} x_j^{\frac{1}{\phi_k}-1} \exp{(\frac{-x_j}{\phi_k \mu})} \Delta_j
\end{split}
$$
This gives for the likelihood: 

$$
\begin{split}
P (D | \mu, \phi) & \propto \prod_{j=1}^{10}  x_j^{\frac{1}{\phi_k}-1} \exp{(\frac{-x_j}{\phi_k \mu})} \Delta_j \\
& \propto \exp{(\frac{- \sum x_j}{\phi_k \mu})}  \prod_{j=1}^{10}  x_j^{\frac{1}{\phi_k}-1}  \Delta_j \\
\end{split}
$$



# Question 2 : Priors 

- Statement 1: we are at 95% convinced that the mean net monthly household income in a given region is in the interval (2400, 3600). If one assumes a normal distribution for the mean $\mu_k$ (à justifier), then it is possible to get a prior of the distriubtion for both regions: 

For both regions $\bar{x} = 3000$. Then, to get the standard deviation: 

$$
\begin{split}
& 3000 - t_{(n_k-1, 1-\alpha/2)} \frac{s_k}{\sqrt{n_k}} = 2400 \\
\rightarrow  & \hat{\sigma} = \frac{s_k}{\sqrt{n_k}}= \frac{600}{t_{(n_k-1, 1-\alpha/2)}}
\end{split}
$$


$\hat{\sigma}_{Fl} = 306$

So we have 

$$
\bar{x}_k \sim N(\mu= 3000, \sigma =306) \propto \sigma^{-1/2} \exp{ \big(-\frac{1}{2\sigma^2}(\bar{x}_k-\mu)^2\big) }
$$


- dispersion parameter: 

If one considers that the parameter can be in any point within the interval (0.0, 10.0) with the same probability, then one could say that it follows a uniform distribution between those to interval 

$$
\phi_k \sim U (a=0,b=10) \propto 1_{0,10}
$$

Using the entropy theorem, the conjugate prior would be the product of the two last quantity: 


$$
\text{prior:}  P(\mu_k, \phi_k) = P(\mu_k) (\phi_k)  \propto 
$$


<!------>
\appendix

# Appendix{#appendix}
## Figures{#figures}
## Code{#code}

\bigskip
\begin{mdframed}[style=thicc, frametitle=Note, frametitlebackgroundcolor=black!30]
  For reproducibility purposes, the complete R project containing the source code and the results is available on \href{https://github.com/AdrienKinart/LSTAT2130BayesianProject}{github.com}.
\end{mdframed}


```{r appendix_pre}
# remotes::install_github('yihui/formatR')
library(formatR)
```

```{r appendix_code, eval=FALSE, echo=TRUE, ref.label=knitr::all_labels(appendix==T)}
```
